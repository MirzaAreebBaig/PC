[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-02 09:34:57.879599",
  "module": "Pharma Compliance",
  "name": "Document Datetime Recording",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "SOP",
  "script": "# Server Script - Before Save event for Document doctype\r\nif not doc.is_new():\r\n    old_doc = frappe.get_doc(\"SOP\", doc.name)\r\n    \r\n    if old_doc.status != doc.status:\r\n        current_datetime = frappe.utils.now_datetime()\r\n        \r\n        if doc.status == \"Under Approval\":\r\n            doc.reviewed_datetime = current_datetime\r\n            \r\n        elif doc.status == \"Effective\":\r\n            doc.approved_datetime = current_datetime",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-06-29 16:18:48.141360",
  "module": "Pharma Compliance",
  "name": "Permission For Document",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "SOP",
  "script": "# Permission Query for Document DocType\n# Role-based visibility: Document Creator, Reviewer, Approver\n\n# Get the current user's email\ncurrent_user_email = frappe.db.get_value('User', frappe.session.user, 'email')\n\n# Get the current user document\nuser = frappe.get_doc('User', frappe.session.user)\n\n# Check if the user is Administrator\nis_administrator = frappe.session.user == 'Administrator'\n\n# Check if the user has privileged roles (can see all documents)\nis_system_manager = any(role.role == 'System Manager' for role in user.roles)\n\n# Check specific document workflow roles\nis_document_creator = any(role.role == 'Document Creator' for role in user.roles)\nis_reviewer = any(role.role == 'Reviewer' for role in user.roles)\nis_approver = any(role.role == 'Approver' for role in user.roles)\n\n# If Administrator or System Manager, no conditions (see all records)\nif is_administrator or is_system_manager:\n    conditions = \"\"\nelif is_document_creator or is_reviewer or is_approver:\n    # Build conditions based on user roles\n    role_conditions = []\n    \n    if is_document_creator:\n        role_conditions.append(f\"prepared_by = '{current_user_email}'\")\n    \n    if is_reviewer:\n        role_conditions.append(f\"reviewed_by = '{current_user_email}'\")\n    \n    if is_approver:\n        role_conditions.append(f\"approved_by = '{current_user_email}'\")\n    \n    # Combine conditions with OR logic\n    conditions = f\"({' OR '.join(role_conditions)})\"\nelse:\n    # For other users, no access\n    conditions = \"1=0\"  # This will show no records",
  "script_type": "Permission Query"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-03 15:25:06.644803",
  "module": "Pharma Compliance",
  "name": "SOP Version Number Check",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "SOP",
  "script": "if doc.document_no and doc.company:\n    existing_count = frappe.db.count('SOP', {\n        'document_no': doc.document_no,\n        'company': doc.company\n    })\n    doc.version_number = f\"{existing_count:02d}\"",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-07-04 10:31:16.083507",
  "module": "Pharma Compliance",
  "name": "SOP Auto Obsolete",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "SOP",
  "script": "# Server Script for SOP DocType\n# Event: After Save\n\n# Check if status is \"Effective\" and supersedes field has value\nif doc.status == \"Effective\" and doc.supersedes:\n    try:\n        # Get the superseded SOP document\n        superseded_sop = frappe.get_doc(\"SOP\", doc.supersedes)\n        \n        # Only update if not already obsolete\n        if superseded_sop.status != \"Obsolete\":\n            # Update the superseded SOP\n            superseded_sop.status = \"Obsolete\"\n            superseded_sop.workflow_state = \"Obsolete\"\n            \n            # Save with system permissions\n            superseded_sop.flags.ignore_permissions = True\n            superseded_sop.flags.ignore_validate = True\n            superseded_sop.save()\n            \n            # Show success message\n            frappe.msgprint(\"SOP \" + doc.supersedes + \" has been automatically set to Obsolete\", alert=True)\n            \n    except Exception as e:\n        # Log error without blocking the main document save\n        frappe.log_error(\"Error updating superseded SOP: \" + str(e), \"SOP Status Update Error\")",
  "script_type": "DocType Event"
 }
]